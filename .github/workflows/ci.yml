name: ApexRun CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  FLUTTER_VERSION: '3.24.0'
  GO_VERSION: '1.22'
  JAVA_VERSION: '17'

jobs:
  # ──────────────────────────────────────────────
  # Flutter: Analyze, Test, Build
  # ──────────────────────────────────────────────
  flutter-analyze:
    name: Flutter Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze --no-fatal-infos

      - name: Check formatting
        run: dart format --set-exit-if-changed lib/ test/

  flutter-test:
    name: Flutter Tests
    runs-on: ubuntu-latest
    needs: flutter-analyze
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run unit tests
        run: flutter test test/unit/ --coverage --reporter=github

      - name: Run widget tests
        run: flutter test test/widget/ --coverage --reporter=github

      - name: Run integration tests
        run: flutter test test/integration/ --coverage --reporter=github

      - name: Upload coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-coverage
          path: coverage/lcov.info

  flutter-build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: flutter-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK (release)
        run: flutter build apk --release --no-tree-shake-icons
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          MAPBOX_ACCESS_TOKEN: ${{ secrets.MAPBOX_ACCESS_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apexrun-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  flutter-build-ios:
    name: Build iOS (no sign)
    runs-on: macos-latest
    needs: flutter-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign --no-tree-shake-icons

  # ──────────────────────────────────────────────
  # Go Backend: Lint, Test, Build
  # ──────────────────────────────────────────────
  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Vet
        run: go vet ./...

      - name: Check formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "Files not formatted:"
            echo "$unformatted"
            exit 1
          fi

  go-test:
    name: Go Tests
    runs-on: ubuntu-latest
    needs: go-lint
    defaults:
      run:
        working-directory: backend
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: apexrun_test
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports: ['6379:6379']
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/apexrun_test?sslmode=disable
          REDIS_URL: localhost:6379
          REDIS_PASSWORD: ''
          PORT: '8080'
          GIN_MODE: test
          SUPABASE_JWT_SECRET: test-secret-key-for-ci

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: backend/coverage.out

  go-build:
    name: Go Build
    runs-on: ubuntu-latest
    needs: go-test
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Build binary
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o apexrun-backend ./cmd/api

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: apexrun-backend-linux
          path: backend/apexrun-backend

  # ──────────────────────────────────────────────
  # ML Service: Lint, Test, Build Docker
  # ──────────────────────────────────────────────
  ml-service:
    name: ML Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ml-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check .

      - name: Build Docker image
        run: docker build -t apexrun-ml-service:ci .

  # ──────────────────────────────────────────────
  # Docker Compose (full stack smoke test)
  # ──────────────────────────────────────────────
  docker-compose:
    name: Docker Compose Smoke Test
    runs-on: ubuntu-latest
    needs: [go-build, ml-service]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build and start services
        run: docker compose up -d --build --wait
        timeout-minutes: 5

      - name: Health check backend
        run: |
          sleep 5
          curl -f http://localhost:8080/health || exit 1

      - name: Health check ML service
        run: curl -f http://localhost:8001/health || exit 1

      - name: Tear down
        if: always()
        run: docker compose down -v
